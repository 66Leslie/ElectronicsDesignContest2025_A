# 三相整流扩展说明

## 概述
在现有三相逆变器的基础上，扩展了三相整流器的同步输出功能。两组输出使用相同的SPWM调制信号，完全同步运行。

## PWM输出配置

### 逆变器输出（原有）
- **TIM8_CH1** (PC6) → A相SPWM
- **TIM8_CH2** (PC7) → B相SPWM  
- **TIM8_CH3** (PC8) → C相SPWM

### 整流器输出（新增）
- **TIM8_CH4** (PC9) → A相SPWM
- **TIM1_CH1** (PE9) → B相SPWM
- **TIM1_CH2** (PE11) → C相SPWM

## 同步机制
- TIM1配置为TIM8的从定时器（通过ITR8触发）
- 两组输出使用相同的占空比计算结果
- 确保逆变器和整流器输出完全同步

## 代码修改要点

### 1. PWM输出更新
```c
// 同时设置逆变器和整流器PWM输出（同步运行）
// 逆变器输出 (TIM8 CH1/CH2/CH3)
__HAL_TIM_SET_COMPARE(&htim8, TIM_CHANNEL_1, duty_cycle_A);  // A相
__HAL_TIM_SET_COMPARE(&htim8, TIM_CHANNEL_2, duty_cycle_B);  // B相
__HAL_TIM_SET_COMPARE(&htim8, TIM_CHANNEL_3, duty_cycle_C);  // C相

// 整流器输出 (TIM8_CH4 + TIM1_CH1/CH2) - 与逆变器同步
__HAL_TIM_SET_COMPARE(&htim8, TIM_CHANNEL_4, duty_cycle_A);  // A相 (PC9)
__HAL_TIM_SET_COMPARE(&htim1, TIM_CHANNEL_1, duty_cycle_B);  // B相 (PE9)
__HAL_TIM_SET_COMPARE(&htim1, TIM_CHANNEL_2, duty_cycle_C);  // C相 (PE11)
```

### 2. PWM使能/禁用
```c
void PWM_Enable(void)
{
    // 使能PWM输出 (GPIO控制)
    HAL_GPIO_WritePin(GPIOE, GPIO_PIN_7, GPIO_PIN_SET);

    // 启动逆变器PWM输出 (TIM8 CH1/CH2/CH3)
    HAL_TIM_PWM_Start(&htim8, TIM_CHANNEL_1);
    HAL_TIM_PWM_Start(&htim8, TIM_CHANNEL_2);
    HAL_TIM_PWM_Start(&htim8, TIM_CHANNEL_3);
    
    // 启动整流器PWM输出 (TIM8_CH4 + TIM1_CH1/CH2)
    HAL_TIM_PWM_Start(&htim8, TIM_CHANNEL_4);
    HAL_TIM_PWM_Start(&htim1, TIM_CHANNEL_1);
    HAL_TIM_PWM_Start(&htim1, TIM_CHANNEL_2);

    pwm_enabled = 1;
}
```

## 验证方法

### 1. 示波器测试
使用示波器同时观察以下信号：
- PC6 (TIM8_CH1) 和 PC9 (TIM8_CH4) - 应该完全同步
- PC7 (TIM8_CH2) 和 PE9 (TIM1_CH1) - 应该完全同步  
- PC8 (TIM8_CH3) 和 PE11 (TIM1_CH2) - 应该完全同步

### 2. 相位关系验证
- A相与B相应相差120°
- B相与C相应相差120°
- C相与A相应相差120°
- 逆变器和整流器对应相位应完全一致

### 3. 频率和调制比测试
- 在不同频率下（10Hz-100Hz）测试同步性
- 在不同调制比下（0.1-1.15）测试输出一致性
- 验证SVPWM算法在两组输出上的一致性

## 注意事项

1. **定时器配置**：确保TIM1已正确配置为TIM8的从定时器
2. **GPIO配置**：确认PE9和PE11已配置为TIM1的复用功能
3. **同步性**：两组输出应无相位差，如有差异需检查定时器配置
4. **负载能力**：注意GPIO的驱动能力，必要时添加缓冲器

## 测试函数
代码中提供了 `Test_Rectifier_Sync()` 函数用于验证同步性：
```c
void Test_Rectifier_Sync(void);
```
此函数将所有PWM输出设置为相同占空比，便于用示波器验证同步性。

## 使用方法
1. 编译并下载代码到MCU
2. 按KEY3启动PWM输出
3. 使用示波器观察六路PWM输出
4. 验证对应通道的同步性
5. 可调用 `Test_Rectifier_Sync()` 进行专门的同步测试

## 应用场景
- 双向变流器系统
- 并联逆变器系统
- 冗余备份系统
- 功率分配系统

## 扩展完成
✅ TIM8_CH4（PC9）输出A相SPWM
✅ TIM1_CH1（PE9）输出B相SPWM
✅ TIM1_CH2（PE11）输出C相SPWM
✅ 与现有三相逆变器完全同步
✅ 统一的PWM使能/禁用控制
✅ 提供同步测试函数
