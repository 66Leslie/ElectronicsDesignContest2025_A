# 三相逆变器测试指南 (更新版)

## 测试前准备

### 硬件连接检查
1. **A相电流和AB线电压测量 (ADC1)**：
   - PA0 ← A相电流传感器输出
   - PA1 ← AB线电压传感器输出

2. **B相电流和BC线电压测量 (ADC2)**：
   - PA6 ← B相电流传感器输出
   - PA7 ← BC线电压传感器输出

3. **参考信号连接 (ADC3)**：
   - PB1 ← 参考信号输入 (用于锁相环)

4. **PWM输出连接**：
   - TIM8: 三相PWM输出 (CH1=A相, CH2=B相, CH3=C相)
   - PE7: PWM使能信号

### 安全检查
- 确保所有传感器输出电压在0-3.3V范围内
- 检查PWM驱动电路的使能信号 (PE7)
- 确认直流母线电压在安全范围内

## 功能测试步骤

### 1. 基本显示和按键测试
```
步骤：
1. 上电启动系统，观察开环模式页面
2. 检查显示内容：调制比、AB线电压、A相电流、BC线电压、B相电流
3. 按KEY5切换到CV模式页面
4. 再按KEY5切换到CC模式页面
5. 再按KEY5回到开环模式页面
6. 测试KEY1/KEY2调整参数功能
7. 测试KEY4切换参考信号功能

预期结果：
- 页面切换正常 (开环→CV→CC→开环)
- 数据格式正确
- 按键响应及时
- 参数调整功能正常
```

### 2. 三相测量数据验证测试
```
步骤：
1. 在开环模式页面观察所有测量值
2. 用万用表测量PA0, PA1, PA6, PA7的实际电压
3. 验证显示的电流和电压值是否合理
4. 检查A相电流和B相电流的关系
5. 检查AB线电压和BC线电压的关系

预期结果：
- 测量值在合理范围内
- A相和B相电流应该有相位关系
- AB和BC线电压应该有相位关系
- 无明显噪声或跳变
```

### 3. 参考信号测试
```
步骤：
1. 按KEY4切换参考信号 (EX/IN)
2. 观察PLL状态显示 (LOCK/UNLK)
3. 在外部参考模式下，检查PB1信号质量
4. 在内部参考模式下，验证系统是否正常工作

预期结果：
- 参考信号切换正常
- 内部参考模式下PLL应该锁定
- 外部参考模式下PLL状态取决于输入信号质量
```

### 4. 控制模式测试
```
步骤：
1. 按KEY5切换控制模式 (Manual → CV → CC → Manual)
2. 在每个模式下观察显示内容变化
3. 在CV模式下用KEY1/KEY2调整电压参考值
4. 在CC模式下用KEY1/KEY2调整电流参考值
5. 在Manual模式下用KEY1/KEY2调整调制比

预期结果：
- 模式切换正常
- 参数调整响应正确
- 显示内容符合当前模式
```

### 5. PWM输出测试 (安全第一!)
```
注意：此测试需要在安全的条件下进行，建议先断开功率电路

步骤：
1. 按KEY3启用PWM输出
2. 用示波器观察TIM8的三相PWM输出
3. 验证三相PWM的相位差是否为120°
4. 检查PWM频率和占空比是否正确
5. 按KEY3关闭PWM输出

预期结果：
- 三相PWM相位差120°
- PWM频率符合设计要求
- 占空比随调制比变化
- 使能/禁用功能正常
```

## 数据记录表格

### ADC测量数据记录
| 测试项目 | ADC1_IN1 | ADC1_IN2 | ADC2_IN3 | ADC2_IN4 | 备注 |
|----------|----------|----------|----------|----------|------|
| 空载测试 |          |          |          |          |      |
| 轻载测试 |          |          |          |          |      |
| 额定负载 |          |          |          |          |      |

### 控制功能测试记录
| 功能 | 测试结果 | 问题描述 | 解决方案 |
|------|----------|----------|----------|
| 显示切换 |          |          |          |
| 按键响应 |          |          |          |
| 模式切换 |          |          |          |
| 参数调整 |          |          |          |
| PWM输出 |          |          |          |

## 常见问题排查

### 1. 显示异常
- 检查OLED连接
- 验证I2C通信
- 检查电源电压

### 2. ADC数据异常
- 检查传感器连接
- 验证传感器供电
- 检查ADC参考电压
- 确认增益系数设置

### 3. PWM输出异常
- 检查TIM8配置
- 验证GPIO配置
- 检查使能信号 (PE7)
- 确认时钟配置

### 4. 锁相环问题
- 检查参考信号质量
- 验证ADC3输入
- 调整锁相环参数
- 检查信号幅度和频率

## 性能优化建议

1. **采样频率优化**：
   - 根据控制需求调整ADC1采样频率
   - 考虑ADC2采样频率是否需要提高

2. **滤波参数调整**：
   - 根据实际噪声情况调整滤波器参数
   - 平衡响应速度和滤波效果

3. **控制参数调优**：
   - 根据负载特性调整PI控制器参数
   - 优化电压环和电流环的响应

4. **显示优化**：
   - 根据使用习惯调整显示内容
   - 考虑添加更多监测信息
